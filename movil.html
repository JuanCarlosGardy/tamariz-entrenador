<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tamariz – Entrenador (Móvil)</title>

  <!-- “Modo app” (mejor en iPhone si lo añades a pantalla de inicio) -->
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tamariz">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:#0b1220;
      color:#e6edf6;
      /* svh evita problemas de barra dinámica de Safari */
      min-height:100svh;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }

    .wrap{
      max-width: 560px;
      margin: 0 auto;
      padding: 12px;
    }

    .card{
      background:#111a2e;
      border:1px solid #223154;
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }

    h1{
      font-size:16px;
      margin:0 0 10px;
      opacity:.95;
    }

    .muted{ opacity:.78; font-size:12px; }
    .ok{ color:#66ffb3; }
    .bad{ color:#ff6b6b; }

    /* ===== Layout “modo app” ===== */
    .app{
      min-height: calc(100svh - 24px); /* deja margen por padding wrap */
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Ajustes plegables */
    details{
      background:#0c1426;
      border:1px solid #2a3a63;
      border-radius:14px;
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      user-select:none;
      font-weight:600;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }

    label{ display:block; font-size:12px; opacity:.88; margin-bottom:6px; }

    input, select, button{
      width:100%;
      box-sizing:border-box;
      border-radius:14px;
      border:1px solid #2a3a63;
      background:#0c1426;
      color:#e6edf6;
      padding:14px 14px;
      outline:none;
    }

    /* Clave iPhone: evita zoom */
    input, select{ font-size:18px; }
    button{ font-size:17px; background:#1b2a4f; border-color:#2e447a; cursor:pointer; }
    button:active{ transform: translateY(1px); }

    /* Zona de juego siempre visible */
    .play{
      background:#0c1426;
      border:1px solid #2a3a63;
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .big{
      font-size:42px;
      font-weight:800;
      letter-spacing:.5px;
      line-height:1;
    }

    #answer{
      font-size:22px;
      height:56px;
      text-transform:uppercase;
    }

    .btnGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:4px;
    }
    .btnGrid button{
      padding:16px 14px;
      border-radius:16px;
    }

    #feedback{
      font-size:14px;
      min-height: 20px;
    }

    .hint{
      font-size:12px;
      opacity:.78;
      line-height:1.35;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card app">
      <h1>Entrenador de Memoria – Mnemónica (Tamariz) · Móvil</h1>

      <!-- Ajustes plegables (para que no “molesten” al jugar) -->
      <details>
        <summary>Ajustes (toca para abrir/cerrar)</summary>

        <div class="row">
          <div>
            <label>Modo</label>
            <select id="mode">
              <option value="numToCard">Número → Carta</option>
              <option value="cardToNum">Carta → Número</option>
              <option value="mixed">Mixto (aleatorio)</option>
              <option value="streak">Racha (mixto, falla = fin)</option>
              <option value="review">Repaso fallos (prioriza lo fallado)</option>
            </select>
          </div>

          <div>
            <label>Dificultad</label>
            <select id="difficulty">
              <option value="all">1–52 (toda la baraja)</option>
              <option value="1-26">1–26</option>
              <option value="27-52">27–52</option>
              <option value="custom">Rango personalizado</option>
            </select>
          </div>

          <div>
            <label>Rango (solo si eliges “Rango personalizado”)</label>
            <div class="row" style="grid-template-columns:1fr 1fr;">
              <input id="rangeFrom" type="number" min="1" max="52" placeholder="Desde (1)" inputmode="numeric" />
              <input id="rangeTo" type="number" min="1" max="52" placeholder="Hasta (52)" inputmode="numeric" />
            </div>
          </div>
        </div>
      </details>

      <!-- Zona de juego -->
      <div class="play">
        <div class="muted">Pregunta</div>
        <div class="big" id="promptText">—</div>
        <div class="muted" id="promptSub">—</div>

        <label id="answerLabel">Tu respuesta</label>
        <input id="answer" autocomplete="off" autocapitalize="characters" placeholder="Escribe aquí" />

        <div class="btnGrid">
          <button id="checkBtn">Validar</button>
          <button id="nextBtn">Siguiente</button>
          <button id="revealBtn">Solución</button>
          <button id="resetBtn">Reset</button>
        </div>

        <div id="feedback"></div>

        <div class="hint">
          Notación: AP, 10C, QR, KT. Palos: P=Picas, C=Corazones, T=Tréboles, R=Rombos (también D=Diamantes).
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const TAMARIZ_STACK = [
    "4T","2C","7R","3T","4C","6R","AP","5C","9P","2P","QC","3R","QT",
    "8C","6P","5P","9C","KT","2R","JC","3P","8P","6C","10T","5R","KP",
    "2T","3C","8R","5T","KP","JR","8T","10P","KC","JT","7P","10C","AR",
    "4P","7C","4R","AT","9T","JP","QR","7T","QP","10R","6T","AC","9R"
  ];

  const normalizeCard = (s) => {
    if (!s) return "";
    const raw = String(s).trim().toUpperCase().replace(/\s+/g,"");
    const hadSymbols = /[♠♥♦♣]/.test(raw);

    let x = raw
      .replace(/♠/g,"S")
      .replace(/♥/g,"H")
      .replace(/♦/g,"D")
      .replace(/♣/g,"C");

    const looksEnglish = hadSymbols || /[SHD]$/.test(x);
    if (looksEnglish) {
      x = x.replace(/S$/,"P").replace(/H$/,"C").replace(/C$/,"T").replace(/D$/,"R");
    }
    x = x.replace(/D$/,"R");
    return x;
  };

  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

  let mnemonic = TAMARIZ_STACK.slice();
  let current=null, startedAt=null;
  let ok=0, bad=0;
  let times=[];
  let wrongWeights=new Map();
  let streak=0, streakBest=0;

  const $ = (id)=>document.getElementById(id);
  const modeEl=$("mode"), diffEl=$("difficulty"), fromEl=$("rangeFrom"), toEl=$("rangeTo");
  const promptText=$("promptText"), promptSub=$("promptSub");
  const answerEl=$("answer"), answerLabel=$("answerLabel"), feedbackEl=$("feedback");

  const STORAGE_KEY="tamariz_mobile_v1";

  const loadState=()=>{
    try{
      const s=localStorage.getItem(STORAGE_KEY);
      if(!s) return;
      const d=JSON.parse(s);
      ok=d.ok??0; bad=d.bad??0;
      times=Array.isArray(d.times)?d.times:[];
      wrongWeights=new Map(Array.isArray(d.wrongWeights)?d.wrongWeights:[]);
      streakBest=d.streakBest??0;
    }catch(e){}
  };

  const saveState=()=>{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      ok,bad,times:times.slice(-500),
      wrongWeights:Array.from(wrongWeights.entries()),
      streakBest
    }));
  };

  const getRange=()=>{
    let a=1,b=52;
    const d=diffEl.value;
    if(d==="1-26"){a=1;b=26;}
    else if(d==="27-52"){a=27;b=52;}
    else if(d==="custom"){
      const fa=parseInt(fromEl.value||"1",10);
      const fb=parseInt(toEl.value||"52",10);
      a=clamp(fa,1,52); b=clamp(fb,1,52);
      if(a>b)[a,b]=[b,a];
    }
    return {a,b};
  };

  const pickPosition=()=>{
    const {a,b}=getRange();
    return a+Math.floor(Math.random()*(b-a+1));
  };

  const weightedPick=()=>{
    const {a,b}=getRange();
    let items=[], total=0;
    for(let pos=a; pos<=b; pos++){
      const card=mnemonic[pos-1];
      const w=(wrongWeights.get(`P:${pos}`)||1)+(wrongWeights.get(`C:${card}`)||1);
      items.push({pos,w}); total+=w;
    }
    let r=Math.random()*total;
    for(const it of items){ r-=it.w; if(r<=0) return it.pos; }
    return items[items.length-1].pos;
  };

  const addWrongWeight=(pos,card)=>{
    wrongWeights.set(`P:${pos}`,(wrongWeights.get(`P:${pos}`)||1)+2);
    wrongWeights.set(`C:${card}`,(wrongWeights.get(`C:${card}`)||1)+2);
  };

  const decayWeights=()=>{
    for(const [k,v] of wrongWeights.entries()){
      if(v>1) wrongWeights.set(k, v*0.98);
    }
  };

  const nextQuestion=()=>{
    let mode=modeEl.value;
    if(mode==="mixed"||mode==="streak"){
      mode=Math.random()<0.5?"numToCard":"cardToNum";
    }

    const pos=(modeEl.value==="review")?weightedPick():pickPosition();
    const card=mnemonic[pos-1];

    current={mode,pos,card};
    startedAt=performance.now();

    if(mode==="numToCard"){
      promptText.textContent=String(pos);
      promptSub.textContent="Di la carta en esa posición.";
      answerLabel.textContent="Tu respuesta (carta)";
      answerEl.placeholder="Ej: QP / 10C / AR";
      answerEl.inputMode="text";
    }else{
      promptText.textContent=card;
      promptSub.textContent="Di el número de esa carta.";
      answerLabel.textContent="Tu respuesta (número)";
      answerEl.placeholder="Ej: 17";
      answerEl.inputMode="numeric";
    }

    feedbackEl.textContent="";
    answerEl.value="";

    // Importante: enfoca y asegura visibilidad en iPhone
    setTimeout(()=>{
      answerEl.focus({preventScroll:false});
      answerEl.scrollIntoView({block:"center", behavior:"smooth"});
    }, 50);
  };

  const checkAnswer=()=>{
    if(!current) return;
    const elapsed=performance.now()-startedAt;
    const raw=answerEl.value;

    let isCorrect=false;
    if(current.mode==="numToCard"){
      isCorrect = normalizeCard(raw) === current.card;
    }else{
      const n=parseInt(String(raw).trim(),10);
      isCorrect = (n===current.pos);
    }

    if(isCorrect){
      ok++; times.push(elapsed);
      feedbackEl.innerHTML=`<span class="ok">Correcto.</span> <span class="muted">(${(elapsed/1000).toFixed(2)}s)</span>`;
      if(modeEl.value==="streak"){ streak++; streakBest=Math.max(streakBest,streak); }
      decayWeights();
      saveState();
      setTimeout(nextQuestion, 450);
      return;
    }

    bad++; addWrongWeight(current.pos,current.card);
    const show = current.mode==="numToCard" ? current.card : String(current.pos);
    feedbackEl.innerHTML=`<span class="bad">Fallo.</span> <span class="muted">La correcta era:</span> <b>${show}</b>`;
    if(modeEl.value==="streak"){ streak=0; }
    saveState();
  };

  const reveal=()=>{
    if(!current) return;
    const show = current.mode==="numToCard" ? current.card : String(current.pos);
    feedbackEl.innerHTML=`<span class="muted">Solución:</span> <b>${show}</b>`;
  };

  const resetAll=()=>{
    ok=0; bad=0; times=[];
    wrongWeights=new Map();
    streak=0; streakBest=0;
    saveState();
    nextQuestion();
  };

  const on=(id,evt,fn)=>{ const el=$(id); if(el) el.addEventListener(evt,fn); };

  on("mode","change",()=>nextQuestion());
  on("difficulty","change",()=>nextQuestion());
  on("rangeFrom","change",()=>nextQuestion());
  on("rangeTo","change",()=>nextQuestion());

  on("checkBtn","click",()=>checkAnswer());
  on("nextBtn","click",()=>nextQuestion());
  on("revealBtn","click",()=>reveal());
  on("resetBtn","click",()=>resetAll());

  answerEl.addEventListener("keydown",(e)=>{ if(e.key==="Enter") checkAnswer(); });

  loadState();
  nextQuestion();
})();
</script>
</body>
</html>
